name: Auto release on PR merge

on:
  pull_request:
    types: [closed, labeled, unlabeled, synchronize]
    branches: [main]
  push:
    tags:
      - "v**"

permissions:
  contents: write
  pull-requests: read
  id-token: write

jobs:
  bump-version:
    name: Bump version when hotfix/* or dev merged
    if: ${{ github.event.pull_request.merged == true && (startsWith(github.event.pull_request.head.ref, 'hotfix/') || github.event.pull_request.head.ref == 'dev') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine bump type from PR labels
        id: bump_type
        shell: bash
        run: |
          labels=$(jq -r '.pull_request.labels[].name' "$GITHUB_EVENT_PATH" 2>/dev/null || true)
          echo "Labels: $labels"
          bump=patch
          if echo "$labels" | grep -qE '(^|[[:space:]])major([[:space:]]|$)'; then
            bump=major
          elif echo "$labels" | grep -qE '(^|[[:space:]])minor([[:space:]]|$)'; then
            bump=minor
          fi
          echo "bump=$bump" >> "$GITHUB_OUTPUT"

      - name: Check if tag exists and get current version
        id: check_tag
        shell: bash
        run: |
          if [ -f "pyproject.toml" ]; then
            current_version=$(grep -E '^version =' pyproject.toml | cut -d'"' -f2)
          elif [ -f "setup.py" ]; then
            current_version=$(grep -E 'version=' setup.py | cut -d"'" -f2)
          else
            current_version="0.0.0"
          fi

          echo "current_version=$current_version" >> "$GITHUB_OUTPUT"

          tag_name="v$current_version"
          if git rev-parse "refs/tags/$tag_name" >/dev/null 2>&1; then
            echo "tag_exists=true" >> "$GITHUB_OUTPUT"
            echo "existing_tag=$tag_name" >> "$GITHUB_OUTPUT"
          else
            echo "tag_exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Delete existing tag if needed
        if: ${{ steps.check_tag.outputs.tag_exists == 'true' && github.event.pull_request.merged == true }}
        shell: bash
        run: |
          tag_name="${{ steps.check_tag.outputs.existing_tag }}"
          echo "åˆ é™¤å·²å­˜åœ¨çš„æ ‡ç­¾: $tag_name"
          git tag -d "$tag_name"
          git push origin ":refs/tags/$tag_name"

      - name: Bump version (bump-my-version)
        id: bump
        uses: callowayproject/bump-my-version@master
        env:
          BUMPVERSION_TAG: "true"
          BUMPVERSION_COMMIT: "true"
        with:
          args: ${{ steps.bump_type.outputs.bump }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Print result
        run: |
          if [ "${{ steps.bump.outputs.bumped }}" = "true" ]; then
            echo "âœ… ç‰ˆæœ¬å·²æ›´æ–°ï¼š ${{ steps.bump.outputs.previous-version }} â†’ ${{ steps.bump.outputs.current-version }}"
            echo "ğŸ”–ğŸ”–ğŸ”–ğŸ”– æ ‡ç­¾ï¼šv${{ steps.bump.outputs.current-version }}"
          else
            echo "â„¹â„¹â„¹â„¹ï¸  æœªæ£€æµ‹åˆ°ç‰ˆæœ¬å˜æ›´ï¼ˆå¯èƒ½æ˜¯åŒä¸€ç‰ˆæœ¬æˆ–é…ç½®é—®é¢˜ï¼‰"
          fi

      - name: Comment on PR with tag info
        if: ${{ steps.bump.outputs.bumped == 'true' }}
        uses: actions/github-script@v6
        env:
          PREV: ${{ steps.bump.outputs.previous-version }}
          CUR: ${{ steps.bump.outputs.current-version }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = `ğŸ”–ğŸ”–ğŸ”–ğŸ”– å·²åˆ›å»ºæ ‡ç­¾ \`v${process.env.CUR}\`ï¼Œä» \`${process.env.PREV}\` å‡çº§ä¸º \`${process.env.CUR}\`.`;
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: pr.number, body });

  update-existing-release:
    name: Update existing release on label changes
    if: ${{ github.event.action == 'labeled' || github.event.action == 'unlabeled' || github.event.action == 'synchronize' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current version and check release
        id: check_release
        shell: bash
        run: |
          if [ -f "pyproject.toml" ]; then
            current_version=$(grep -E '^version =' pyproject.toml | cut -d'"' -f2)
          elif [ -f "setup.py" ]; then
            current_version=$(grep -E 'version=' setup.py | cut -d"'" -f2)
          else
            current_version="0.0.0"
          fi

          echo "current_version=$current_version" >> "$GITHUB_OUTPUT"
          tag_name="v$current_version"
          echo "tag_name=$tag_name" >> "$GITHUB_OUTPUT"

      - name: Check if release exists
        id: check_existing_release
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tagName = '${{ steps.check_release.outputs.tag_name }}';
            try {
              const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tagName
              });
              console.log(`æ‰¾åˆ°å·²å­˜åœ¨çš„å‘è¡Œç‰ˆ: ${release.data.name}`);
              return release.data.id;
            } catch (error) {
              console.log(`æœªæ‰¾åˆ°æ ‡ç­¾ ${tagName} å¯¹åº”çš„å‘è¡Œç‰ˆ`);
              return null;
            }

      - name: Update existing release
        if: ${{ steps.check_existing_release.outputs.release_id != null }}
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const releaseId = '${{ steps.check_existing_release.outputs.release_id }}';
            const tagName = '${{ steps.check_release.outputs.tag_name }}';
            const prNumber = context.payload.pull_request?.number;

            const labels = context.payload.pull_request?.labels || [];
            const labelNames = labels.map(label => label.name);

            let body = `## æ›´æ–°ä¿¡æ¯\n`;
            body += `- **PR**: #${prNumber}\n`;
            body += `- **è§¦å‘äº‹ä»¶**: ${context.payload.action}\n`;
            body += `- **ç›¸å…³æ ‡ç­¾**: ${labelNames.join(', ') || 'æ— '}\n`;
            body += `- **æ›´æ–°æ—¶é—´**: ${new Date().toISOString()}\n\n`;

            try {
              const fs = require('fs');
              if (fs.existsSync('CHANGELOG.md')) {
                const changelog = fs.readFileSync('CHANGELOG.md', 'utf8');
                body += `## å˜æ›´æ—¥å¿—\n${changelog}`;
              }
            } catch (error) {
              console.log('æ— æ³•è¯»å– CHANGELOG.md æ–‡ä»¶');
            }

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: releaseId,
              tag_name: tagName,
              body: body,
              draft: false,
              prerelease: false
            });

            console.log(`âœ… å·²æ›´æ–°å‘è¡Œç‰ˆ ${tagName}`);

  build:
    name: Release
    runs-on: ubuntu-latest
    needs: [bump-version, update-existing-release]
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: å®‰è£… uv å¹¶ä¾èµ–
        uses: astral-sh/setup-uv@v7.1.6
        with:
          github-token: ${{ github.token }}
          enable-cache: "auto"

      - name: æ„å»º
        run: uv build --clear

      - name: Create or Update Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          files: |
            dist/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Handle release updates
        if: steps.create_release.outcome == 'success'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const releaseId = '${{ steps.create_release.outputs.id }}';
            const tagName = '${{ github.ref_name }}';

            if (releaseId) {
              console.log(`âœ… å‘è¡Œç‰ˆ ${tagName} å¤„ç†å®Œæˆ`);
              
              if (context.payload.action && ['labeled', 'unlabeled', 'synchronize'].includes(context.payload.action)) {
                await github.rest.repos.updateRelease({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: releaseId,
                  name: `${tagName} (å·²æ›´æ–°)`
                });
              }
            }
