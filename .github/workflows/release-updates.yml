name: Manual release with version bump

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      tag_name:
        description: "Custom tag name (optional, will use bumped version if empty)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: read
  id-token: write

jobs:
  bump-version:
    name: Bump version and create release
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.set_tag.outputs.tag_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate bump type
        id: validate
        shell: bash
        run: |
          bump_type="${{ github.event.inputs.bump_type }}"
          if [[ ! "$bump_type" =~ ^(patch|minor|major)$ ]]; then
            echo "âŒ é”™è¯¯çš„ bump_type: $bump_type. å¿…é¡»æ˜¯ patch, minor æˆ– major"
            exit 1
          fi
          echo "bump_type=$bump_type" >> $GITHUB_OUTPUT

      - name: Get current version
        id: get_version
        shell: bash
        run: |
          if [ -f "pyproject.toml" ]; then
            current_version=$(grep -E '^version =' pyproject.toml | cut -d'"' -f2)
          elif [ -f "setup.py" ]; then
            current_version=$(grep -E 'version=' setup.py | cut -d"'" -f2)
          else
            current_version="0.0.0"
          fi

          echo "current_version=$current_version" >> "$GITHUB_OUTPUT"
          echo "å½“å‰ç‰ˆæœ¬: $current_version"

      - name: Bump version (bump-my-version)
        id: bump
        uses: callowayproject/bump-my-version@master
        env:
          BUMPVERSION_TAG: "true"
          BUMPVERSION_COMMIT: "true"
        with:
          args: ${{ steps.validate.outputs.bump_type }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set tag name
        id: set_tag
        shell: bash
        run: |
          custom_tag="${{ inputs.tag_name || '' }}"
          if [ -n "$custom_tag" ]; then
            tag_name="$custom_tag"
            echo "ä½¿ç”¨è‡ªå®šä¹‰æ ‡ç­¾: $tag_name"
          else
            tag_name="v${{ steps.bump.outputs.current-version }}"
            echo "ä½¿ç”¨ç‰ˆæœ¬æ ‡ç­¾: $tag_name"
          fi

          echo "tag_name=$tag_name" >> $GITHUB_OUTPUT

      - name: Print version info
        run: |
          echo "âœ… ç‰ˆæœ¬å·²æ›´æ–°ï¼š ${{ steps.bump.outputs.previous-version }} â†’ ${{ steps.bump.outputs.current-version }}"
          echo "ğŸ”– æ ‡ç­¾ï¼š${{ steps.set_tag.outputs.tag_name }}"
          echo "ğŸ“ˆ æ›´æ–°ç±»å‹ï¼š${{ inputs.bump_type }}"

  build:
    name: Build and Release
    runs-on: ubuntu-latest
    needs: bump-version
    if: success()

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: å®‰è£… uv å¹¶ä¾èµ–
        uses: astral-sh/setup-uv@v7.1.6
        with:
          github-token: ${{ github.token }}
          enable-cache: "auto"

      - name: æ„å»º
        run: uv build --clear

      - name: Extract release notes section
        id: extract_notes
        shell: bash
        run: |
          awk '/^### /{i++}i==1{print}i==2{exit}' CHANGELOG.md | sed '1d' > RELEASE_BODY.md

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.bump-version.outputs.tag_name }}
          body_path: RELEASE_BODY.md
          draft: false
          prerelease: false
          files: |
            dist/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release success message
        run: |
          echo "âœ… å‘è¡Œç‰ˆ ${{ needs.bump-version.outputs.tag_name }} åˆ›å»ºæˆåŠŸ"
